<!DOCTYPE html>
<html>
    <head>
        <title>Nice.Social</title>
        <meta name="description" content="A Better Way to Interact on App.Net">
        <meta name="viewport" content="width=device-width initial-scale=1.0 maximum-scale=1.0 user-scalable=yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="format-detection" content="telephone=no">
        <meta name="robots" content="index, follow">
        <meta http-equiv="cleartype" content="on">
        <meta charset="utf-8">

        <link type="text/css" rel="stylesheet" href="css/style.css" />
        <link type="text/css" rel="stylesheet" href="css/font-awesome.css" />
        <link type="text/css" rel="stylesheet" href="css/jquery.mmenu.all.css" />

        <link href="img/apple-touch-icon.png" rel="apple-touch-icon" />
        <link href="img/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" />
        <link href="img/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" />
        <link href="img/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" />
        <link href="img/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
        <link href="img/icon-hires.png" rel="icon" sizes="192x192" />
        <link href="img/icon-normal.png" rel="icon" sizes="128x128" />

        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/jss.min.js"></script>
    </head>
    <body>
        <div id="page">
            <div id="header_bar" class="header fixed">
                <a id="mnu-avatar" onclick="doShowPrefs('main');"></a>
                <span id="hd-activity" class="hide"><i class="fa fa-refresh fa-spin"></i></span>
                <span id="hd-spacer" class="show">&nbsp;</span>
                <strong id="site-name">{Don&apos;t Forget To Set a Site Name}</strong>
                <button id="doAction">Sign In</button>
            </div>
            <div id="tl-content" class="content">
                <div id="tl-space" class="timelines"></div>
            </div>
            <div id="splash" class="dialog hide">
                <div class="progress">
                    <i class="fa fa-spinner fa-pulse"></i>
                    <span id="prog-msg">&nbsp;</span>
                </div>
            </div>
            <div id="response" class="dialog hide">
                <div class="reply">
                    <div class="entry">
                        <textarea id="rpy-text" class="mention"></textarea>
                    </div>
                    <div class="actions">
                        <span id="rpy-length">256</span>
                        <span id="rpy-draft" style="padding-left: 15px; font-size: 150%;" onclick="loadDraft();"></span>
                        <button id="rpy-kill" class="btn-red">Cancel</button>
                        <button id="rpy-send" class="btn-grey">Send</button>
                    </div>
                </div>
            </div>
            <div id="gallery" class="photo hide">
                <div class="close" onclick="showHideGallery();"></div>
                <div id="img-show" class="panel"></div>
            </div>
            <div id="conversation" class="dialog hide"></div>
            <div id="draftbox" class="dialog hide">
                <div class="msgbox">
                    <div class="title">Before You Go ...</div>
                    <div id="msg" class="message">Would you like to save this message as a draft?</div>
                    <div class="buttons">
                        <button onclick="showSaveDraft();" class="btn-red">No, Thanks</button>
                        <button onclick="saveDraft();" class="btn-green">Yes, Please</button>
                    </div>
                </div>
            </div>
            <div id="autocomp" class="dialog hide"></div>
            <div id="hashbox" class="dialog hide"></div>
            <div id="dialog" class="dialog hide"></div>
            <div id="okbox" class="dialog hide"></div>
            <div id="prefs" class="dialog hide"></div>
        </div>
        <script type="text/javascript" src="js/dom.js"></script>
        <script type="text/javascript" src="js/storage.js"></script>
        <script type="text/javascript" src="js/prefs.js"></script>
        <script type="text/javascript" src="js/core.js"></script>
        <script>
            jQuery(function($) {
                window.store = new Object();
                window.chans = {};
                window.posts = {};
                window.users = {};
                window.activate = false;
                window.timelines = { home     : false,
                                     mentions : false,
                                     global   : true,
                                     pms      : false
                }
                loadConfigFile();
                window.KEY_ENTER = 13;
                window.KEY_ESCAPE = 27;
                window.KEY_K = 75;
                window.KEY_N = 78;
                window.KEY_F2 = 113;
                window.KEY_F3 = 114;
                window.KEY_DOWNARROW = 40;

                $('#doAction').click(function() { doPostOrAuth(); });
                $('#rpy-kill').click(function() { killPost(); });
                $('#rpy-send').click(function() { sendPost(); });
                $("#rpy-text").keyup(function() {
                    var caret = getCaretPos(this);
                    var result = /\S+$/.exec(this.value.slice(0, caret));
                    var lastWord = result ? result[0] : null;
                    if ( lastWord !== undefined && lastWord !== '' && lastWord !== null ) {
                        if ( lastWord.length >= 4 && lastWord.charAt(0) === '@' ) {
                            listNames( lastWord );
                        } else {
                            if( $('#autocomp').hasClass('show') ) { $('#autocomp').removeClass('show').addClass('hide') }
                        }
                    }

                    doHandyTextSwitch();
                });
                $("#rpy-text").keydown(function (event) { 
                    if ( (event.metaKey || event.ctrlKey) && event.keyCode === KEY_ENTER ) { 
                        sendPost();
                    }
                    if ( $('#autocomp').hasClass('show') && event.keyCode === KEY_DOWNARROW) {
                        $('#autocomp > .autobox > span:first-child').trigger("click");
                        return false;
                    } 
                });
                $(document).keyup(function(e) {
                    if( $('#response').hasClass('hide') ) { if ( event.keyCode === KEY_N ) { showHideResponse(); } }
                    if ( event.keyCode === KEY_F2 ) { $('#autocomp').removeClass('show').addClass('hide'); }
                });
                $(document).keydown(function(e) {
                    var cancelKeyPress = false;
                    if ( (e.metaKey || e.ctrlKey) && e.keyCode == KEY_K ) { clearTimelines(); cancelKeyPress = true; }
                    if (e.keyCode === KEY_ESCAPE) {
                        toggleClassIfExists('gallery', 'show', 'hide');
                        cancelKeyPress = true;
                        killPost();
                    }
                    if ( e.keyCode === KEY_F3 ) { doShowPrefs('main'); cancelKeyPress = true; }
                    if (cancelKeyPress) { return false; }
                });
                document.addEventListener('focusout', function(e) {window.scrollTo(0, 0)});
                $( window ).resize(function() { setWindowConstraints(); });
            });
            window.addEventListener('load', function(){
                var touchsurface = document.getElementById('rpy-text'),
                    touchMenu = document.getElementById('header_bar'),
                    startX,
                    startY,
                    dist,
                    threshold = 150,
                    allowedTime = 1000,
                    elapsedTime,
                    startTime;
                function handleswipe(isRightSwipe, isLeftSwipe) {
                    if ( isRightSwipe === true ) { setCursorPosition( 1 ); }
                    if ( isLeftSwipe === true ) { setCursorPosition( -1 ); }
                }
                function handleMenuSwipe(isRightSwipe, isLeftSwipe) {
                    if ( isRightSwipe === true ) { rotateTimelines(); }
                    if ( isLeftSwipe === true ) { rotateTimelines(); }
                }
                function rotateTimelines() {
                    var els = document.getElementsByClassName("post-list");
                    var showNext = false;
                    var cnt = 0;

                    for (i in window.timelines) {
                        if ( showNext ) {
                            if ( window.timelines.hasOwnProperty(i) ) {
                                window.timelines[i] = true;
                                if ( window.timelines[i] ) { saveStorage('tl_' + i, 'Y'); } else { saveStorage('tl_' + i, 'N'); }
                                break;
                            }
                        }
                        if ( els[0].id === i ) {
                            if ( window.timelines.hasOwnProperty(i) ) {
                                window.timelines[i] = !window.timelines[i];
                                if ( window.timelines[i] ) { saveStorage('tl_' + i, 'Y'); } else { saveStorage('tl_' + i, 'N'); }
                                showNext = true;
                            }
                        } else {
                            window.timelines[i] = false;
                        }
                    }
                    for (i in window.timelines) { if ( window.timelines[i] ) { cnt++; } }
                    if ( cnt == 0 ) { window.timelines['home'] = true; }
                    showTimelines();
                }
                function setCursorPosition( PlusMinus ) {
                    var txtBox = document.getElementById('rpy-text');
                    setCaretToPos(txtBox, txtBox.selectionEnd + PlusMinus);
                }
                touchMenu.addEventListener('touchstart', function(e) {
                    var touchobj = e.changedTouches[0];
                    dist = 0;
                    startX = touchobj.pageX;
                    startY = touchobj.pageY;
                    startTime = new Date().getTime();
                }, false);
                touchMenu.addEventListener('touchend', function(e){
                    var touchobj = e.changedTouches[0];
                    dist_r = touchobj.pageX - startX;
                    dist_l = startX - touchobj.pageX;
                    elapsedTime = new Date().getTime() - startTime;
                    var isRightSwipe = (elapsedTime <= allowedTime && dist_r >= threshold && Math.abs(touchobj.pageY - startY) <= 100),
                        isLeftSwipe = (elapsedTime <= allowedTime && dist_l >= threshold && Math.abs(touchobj.pageY - startY) <= 100);
                    handleMenuSwipe(isRightSwipe, isLeftSwipe);
                    if ( isRightSwipe || isLeftSwipe ) { e.preventDefault(); }
                }, false);

                touchsurface.addEventListener('touchstart', function(e) {
                    touchsurface.innerHTML = '';
                    var touchobj = e.changedTouches[0];
                    dist = 0;
                    startX = touchobj.pageX;
                    startY = touchobj.pageY;
                    startTime = new Date().getTime();
                }, false);
                touchsurface.addEventListener('touchmove', function(e){ e.preventDefault(); }, false);
                touchsurface.addEventListener('touchend', function(e){
                    var touchobj = e.changedTouches[0];
                    dist_r = touchobj.pageX - startX;
                    dist_l = startX - touchobj.pageX;
                    elapsedTime = new Date().getTime() - startTime;
                    var isRightSwipe = (elapsedTime <= allowedTime && dist_r >= threshold && Math.abs(touchobj.pageY - startY) <= 100),
                        isLeftSwipe = (elapsedTime <= allowedTime && dist_l >= threshold && Math.abs(touchobj.pageY - startY) <= 100);
                    handleswipe(isRightSwipe, isLeftSwipe);
                    if ( isRightSwipe || isLeftSwipe ) { e.preventDefault(); }
                }, false); 
            }, false);
            function doMore( post_id ) {
                alert( "[Debug] Let's Show another Modal for Post: " + post_id );
            }
        </script>
    </body>
</html>